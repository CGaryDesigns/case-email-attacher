<apex:page 
    applyBodyTag="true" 
    applyHtmlTag="false" 
    cache="false" 
    contentType="text/html" 
    docType="html-5.0"
    standardController="Case"
    extensions="CaseEmailAttachmentsActionExt"
    id="CaseEmailAttachmentsAction"
    label="CaseEmailAttachmentsAction"
    language="en-US"
    name="CaseEMailAttachmentsAction"
    showChat="false"
    showHeader="false"
    sidebar="false"
    standardStylesheets="true"
    title="Case Email with Attachments">
<html  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" lang="en">
    <apex:includeScript id="AngularJSCore" value="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.min.js"/>

    <apex:slds />

    <div class="slds-scope" ng-app="pageApp">
        <div class="slds-grid" ng-controller="MainController">
            <div class="slds-col">
                <ul class="slds-accordion">
                    <li class="slds-accordion__list-item">
                        <section ng-class="emailTemplateSelectionAccordion">
                            <div class="slds-accordion__summary">
                                <h3 class="slds-text-heading_small slds-accordion__summary-heading">
                                    <button aura-controls="accordion-details-01" aria-expanded="false" class="slds-button slds-button_reset slds-accordion__summary-action" ng-click="toggleTemplateSelection();">
                                        <svg class="slds-accordion__summary-action-icon slds-button__icon slds-button__icon_left" aria-hidden="true">
                                            <use xmlns:link="https://www.w3org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS,'/assets/icons/utility-sprite/svg/symbols.svg#switch')}"/>
                                        </svg>
                                        <span class="slds-truncate" title="Template Selection">Template Selection</span>
                                    </button>
                                </h3>
                            </div>

                            <div aria-hidden="true" class="slds-accordion__content" id="accordion-details-01">
                                <div class="slds-grid slds-grid_pull-padded-medium">
                                    <div class="slds-col slds-p-horizontal_medium">
                                        <div class="slds-form slds-form_stacked">
                                            <div class="slds-form-element">
                                                <label class="slds-form-element__label" for="select-template-folder">Template Folder</label>
                                                <div class="slds-form-element__control">
                                                    <div class="slds-select_container">
                                                        <select ng-model="templateFolder" name="select-template-folder" multiple="false" ng-options="option.name for option in folderList"></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var pageApp = angular
                        .module('pageApp',[])
                        .factory('SFDCFactory',['$rootScope','$log','$q',function($rootScope,$log,$q){
                            var factoryObj = {};
                            factoryObj.ObtainFolderList = function(){
                                var deferred = $q.defer();
                                Visualforce.remoting.Manager.invokeAction(
                                    '{!$RemoteAction.CaseEmailAttachmentsActionExt.ObtainEmailTemplateFolders}',
                                    function(result,event){
                                        $rootScope.$apply(function(){
                                            if(event.status){
                                                $log.info(result);
                                                deferred.resolve(result);
                                            } else {
                                                deferred.reject(event.message);
                                            }
                                        });
                                    },
                                    {
                                        escape:false,
                                        timeout:60000
                                    }
                                )
                                return deferred.promise;
                            }
                            return factoryObj;
                        }])
                        .controller('MainController',['$scope','$window','$log','SFDCFactory',function($scope,$window,$log,SFDCFactory){
                            
                            //the object that controls the class for showing template info
                            $scope.emailTemplateSelectionAccordion = {
                                "slds-accordion__section":true,
                                "slds-is-open":false
                            };
                            //variable hold list of Email Template folders
                            $scope.folderList = [];
                            //variable to hold selected folder
                            $scope.templateFolder = {};
                            /**
                             * function responsible for toggling the visibility
                             * of the Template selection area
                             **/
                            $scope.toggleTemplateSelection = function(){
                                $scope.emailTemplateSelectionAccordion['slds-is-open']  = !$scope.emailTemplateSelectionAccordion['slds-is-open'];
                            }
                            /**
                             * function that will be called to represent the initialization
                             * all processes that need to be run to set up the page are to be called
                             * here.
                             **/
                            var initialize = function(){
                                //populate the folder select list
                                SFDCFactory.ObtainFolderList().then(
                                    function(result){
                                        for(key in result){
                                            var obj = { 'name':key, 'id':result[key]};
                                            $log.info('Transformed Object: ' + JSON.stringify(obj));
                                            $scope.folderList.push(obj);
                                        }
                                    },
                                    function(reject){
                                        $log.error('There was a problem: ' + reject);
                                    }
                                );
                                //signal that the application has started
                                $log.info('Application Started.');
                            }

                            initialize();

                        }]);
    </script>
</html>
</apex:page>
